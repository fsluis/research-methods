---
title: "Lab & Stats Weeks"
author: "Frans van der Sluis, Mara Günther, Lorna Wildegaard (2019 version)"
date: "`r Sys.Date()`"
output:
  html_document:
    css: styles.css
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, results = "hide")
```

# LAB SESSION 2: INFERENTIAL STATISTICS (PART 1)

## Topics

- Paired-samples t-test
- Independent samples t-test
- Tidyverse/dplyr's group_by and group-wise summaries
- Assumptions of t-tests

<mark>Todo: Add resources</mark>

# Introduction

The goal of this lab session is to learn how to perform Student’s t-tests using R. In this session, we will analyze the data from our experiment on typing speed (words per minute, *WPM*) using two different keyboards: the Opti keyboard and the QWERTY keyboard. 
<!--In addition to the typing speed data, the dataset includes demographic information such as gender, age, language, computer use (hours per day), and messages sent.-->
The data are stored in long format in the file `keyboard_data_R_2024.csv`, which means that each row corresponds to one trial. Key variables include:

- **ParticipantID** (unique identifier)
- **Keyboard** (with values "OPTI" or "QWERTY")
- **Trial_order** (e.g., 1 to 5)
- **Reaction_Time**
- **WPM**

Before beginning, ensure that you have already completed Lab 1 (Descriptive Statistics) and loaded your dataset into R.

# 1. Paired-Samples t-Test
The data set contains data from a controlled experiment on typing speed using the Opti keyboard
vs Qwerty keyboard. There are many different research questions we can investigate, e.g.:

- **RQ1**: Is there a difference in words per minute (wpm) between typing on the Opti vs. Qwerty keyboard?
- **RQ2**: Is there a difference in wpm between males and females?
- **RQ3**: Is there a difference in typing speed between our two older and younger student
groups?

The experiment used a within-group design for the different keyboards. All participants were asked to complete typing
tasks on Opti and on Qwerty keyboards. That means that we have paired observations: typing speed in words/minute on Opti and typing speed in words/minute on Qwerty. 
In addition, the participants’ gender (Sex) and age (Age) were also recorded.

We start with our first research question (RQ1): 
<div class="question">
1. Formulate the null and alternative hypothesis for answering RQ1.
</div>

```{r, echo=FALSE}
# Read in the long-format dataset
keyboard_data <- read.csv("keyboard_data_R_2024.csv")
library(dplyr)
```
Let's first describe our data for either keyboard. 
We can summarize (aggregate) our data per keyboard using the 'group_by' function.
It calculates the mean and standard deviation (both its parametric and non-parametric alternatives) for each group (Keyboard):
```{r}
keyboard_data %>%
  group_by(Keyboard) %>%
  summarise(Mean = mean(WPM, na.rm = TRUE),
            Std = sd(WPM, na.rm = TRUE),
            Median = median(WPM, na.rm = TRUE),
            MAD = mad(WPM, na.rm = TRUE)
)
```
Take a look at the output;
<div class="question">
2. Do you think we will be able to confirm Ha?
</div>

Since every participant completes trials on both keyboards, we have repeated measures for each participant. This means each participant contributes paired observations (one for the OPTI condition and one for the QWERTY condition). In **rstatix**, we can perform a paired t-test on long-format data using the pipe notation:



```{r}
library(rstatix)
library(dplyr)

keyboard_data %>%
  arrange(ParticipantID,Trial_order) %>%
  t_test(WPM ~ Keyboard, paired = TRUE)
```

Explanation of the Formula Notation and Pairing:

- **Sorting (`arrange(ParticipantID,Trial_order)`)**
RStatix assumes that the first observation in one condition (e.g. OPTI) corresponds to the first observation in the other condition (e.g. QWERTY), the second to the second, and so on. To make sure this is the case for our data, we first order the data by ParticipantID-Trial_order.

- **Formula (`WPM ~ Keyboard`)**:
  This follows the standard R formula syntax. It specifies that we want to compare the WPM values (the dependent variable) across the levels of Keyboard (the independent variable): "OPTI" and "QWERTY".

- **Paired Argument (`paired = TRUE`)**:
  By setting `paired = TRUE`, we tell `t_test()` that the observations are not independent. Instead, each observation in one condition (e.g., OPTI) should be paired with an observation in the other condition (e.g., QWERTY) from the same ParticipantID / Trial_order.

A note on sample normality and t-tests:
The t-test doesn't assume that the individual data points (our sample) are normally distributed. It assumes that the means of samples taken from the population are normally distributed. This is known as the sampling distribution of the mean. Even though our sample shows positive skew, if our sample size is large enough (usually 20–30 or more), the central limit theorem tells us that the distribution of the sample means will be approximately normal. Thus, the t-test remains valid despite our sample data's skewness.

<div class="question">
3. Report the results of a paired-samples t-test for the other OPTI vs QWERTY variables in APA style.
</div>

When reporting your t-test in APA style, include:

- Means and standard deviations for each condition.
- The t-value with its degrees of freedom, the p-value, and optionally an effect size.

For example:
"*A paired-samples t-test indicated that WPM scores were significantly higher in the OPTI condition (M = 80.1, SD = 12.3) than in the QWERTY condition (M = 75.4, SD = 10.8), t(29) = 2.35, p = .026, d = 0.45.*"

Tip: Negative t-values: The sign of a t-value tells us the direction of the difference in sample
means, which can be difficult to interpret without further explanation: Does a negative t-value
indicate Opti’s sample mean was greater or smaller than Qwerty? Therefore, it is common to
indicate the direction of the mean-difference (even if nonsignificant) in some other way, such as by
mentioning the sample means in the text, or by showing the sample means graphically, as in a bar
chart. 

```{r, echo=FALSE}
# Some tests for different methods to structure data / t-tests
# Compare with base r, assuming the order of observations map between keyboards
opti_wpm = keyboard_data %>% filter(Keyboard=="OPTI") %>% select(WPM)
qwerty_wpm = keyboard_data %>% filter(Keyboard=="QWERTY") %>% select(WPM)
t.test(opti_wpm,qwerty_wpm)
# should be the same
```

```{r, echo=FALSE}
# Compare with base r, dropping that assumption
library(tidyverse)
wide_data <- keyboard_data %>%
  pivot_wider(
    id_cols = c(ParticipantID, Trial_order),
    names_from = Keyboard,
    values_from = WPM,
    names_glue = "{Keyboard}_WPM"
  )
t.test(wide_data$OPTI_WPM, wide_data$QWERTY_WPM, paired = TRUE)
# should be the same
```

```{r, echo=FALSE}
# Small test to see how the results change when we shuffle the order of observations for each participant
data_reorder = keyboard_data %>%
        group_by(ParticipantID) %>%
        # Create a new variable 'New_Trial_order' by shuffling the unique trial orders for that participant.
        mutate(New_Trial_order = sample(unique(Trial_order))[match(Trial_order, sort(unique(Trial_order)))]) %>%
        ungroup() %>% 
        arrange(ParticipantID,New_Trial_order) 
data_reorder %>%
        t_test(WPM ~ Keyboard, paired = TRUE)
# should be different
```

```{r, echo=FALSE}
# Small test to see how the results change when we shuffle the order of observations for each participant
keyboard_data %>%
        sample_frac(1) %>%
        t_test(WPM ~ Keyboard, paired = TRUE)
# should be different
```


# 2. Paired samples t-test on subgroups
What we’ve done in answering RQ1 is group all participants together. But the fact that we
found a statistically significant difference does not mean that this difference also exists within our
subgroups, e.g., is there also a significant difference between typing on the OPTI keyboard
vs.QWERTY for our two age groups, younger and older students? To be able to answer this
question, we need to temporarily de-select all older participants in our data set.

The first task is to recode your Age variable into two groups that fit your data and create an
Age_group variable, dividing the respondents into a “younger” and “older” group:
<!--. First, make a
frequency analysis and decide how you want to divide your respondents into two somewhat equally
sized groups. 
Lab1, heading: "Frequency distribution table" shows you how to use count to get the frequencies of values in the sample.
Lab1, heading "Re-coding variables", shows you how to re-code a continuous variable into a categorical one.
-->

1. Check the frequency distribution of your Age variable (see Lab1, "Frequency distribution table") to understand its distribution.
```{r, echo=FALSE}
age_freq <- keyboard_data %>% 
  count(Age) %>% 
  arrange(Age)
print(age_freq)
```

2. Use R to calculate the median of Age:  
   ```r
   age_median <- median(keyboard_data$Age, na.rm = TRUE)
   print(age_median)
   ```
   
3. Based on the frequency table and the median value, decide on a cutoff that divides your sample into two roughly equal groups. In many cases, the median is a good choice.
```{r,echo=FALSE}
# Use the median age as the threshold (you can choose another value based on your analysis)
age_median <- median(keyboard_data$Age, na.rm = TRUE)
age_median
```

4. Using the method shown in Lab1 ("Re-coding variables"), create a new variable (Age_group) that assigns participants to "younger" (if Age is less than or equal to the median) or "older" (if Age is above the median).
```{r,echo=FALSE}
# Create the Age_group variable
keyboard_data <- keyboard_data %>%
  mutate(Age_group = if_else(Age <= age_median, "younger", "older"))

# Check the distribution of the new Age_group variable
keyboard_data %>% 
  count(Age_group)
```

<div class="question">
4. What level of measurement (nominal, ordinal, interval, ratio) is the Age_group variable measured at?
</div>

Second, we need to filter our dataframe on a subgroup of younger students. In Lab1 we filtered twice: on a specific partipant (ID: 5193237) and on a specific keyboard (OPTI). Use the same filter command to now filter on younger students. 

<div class="question">
5. Is there a statistically significant difference in wpm when typing on the OPTI vs QWERTY
keyboard among our younger group of students (at &alpha; = 0.05)? Formulate the null/alternative
hypotheses, perform the paired-samples t-test, and report the results APA-style.
</div>


# 3. Independent-Samples t-Test


Now that we have answered our first research question, we can move on to our second:

**RQ2:** Is there a difference in wpm between males and females?

If we want to investigate differences between the genders, then we suddenly have a between-group design
on our hands: you cannot be both female and male at the same time. That means that
the genders form two independent groups, which in turn means that we have to use an
independent-samples t-test. 

To compare participants, we first need to aggregate our data at the participant level by calculating the mean WPM for each participant:
```{r mean-wpm, echo=TRUE}
mean_wpm <- keyboard_data %>%
  group_by(ParticipantID,Sex) %>%
  summarize(Mean_WPM = mean(WPM, na.rm = TRUE), .groups = "drop") 
head(mean_wpm)
```
<!-- # .groups parameter does the same as calling ungroup() afterwards -->

Using this aggregated dataframe we can perform an independent-samples t-test. You can use the same function call as before (t_test), though without the 'paired=TRUE' parameter. You will also need to change the formula: Instead of predicting WMP by Keyboard, we will now compare mean_WPM by Sex.

```{r independent-t-test-gender, echo=FALSE}
t_test(Mean_WPM ~ Sex, data = mean_wpm)
#t.test(mean_WPM ~ Sex, data = mean_wpm) # base R also works here
```

<div class="question">
<!--8. Report the results of this independent-samples t-test for RQ2 (with a = 0.05).-->
6. Investigate RQ2. Formulate the null/alternative hypotheses, <mark>use the appropriate chart to
visualize the differences between the female and male participants</mark>, perform the
independent-samples t-test, and report the results for RQ2 (with a = 0.05).
</div>

<mark>Todo: 'The appropriate chart': population pyramid / side-by-side histograms? Add to / check lab1.

```{r, echo=FALSE}
p <- ggplot(keyboard_data, aes(x = WPM, fill = Sex)) +
     geom_histogram(binwidth = 5, alpha = 0.7, position = "dodge") +
     facet_grid(. ~ Sex) + coord_flip() +
     labs(title = "WPM Distribution by Gender",
          x = "WPM",
          y = "Frequency") +
     theme_minimal()
```

## Levene's test
The t-test assumes that variances within both groups are equal This is called the 'equality of variances assumption'. 
To test this, you can run Levene’s test. If the p-value is above 0.05, you assume equal variances and use the standard t-test; if below, you must use the t-test with different instructions.
```r
library(car)
leveneTest(Mean_WPM ~ Sex, data = mean_wpm)
```

<div class="question">
7. Run the code, can we assume equal variances between males and females? 
</div>

If significant, revisit the previous question and include the parameter `var.equal = FALSE` in your t_test call.

```{r independent-t-test-gender-inequal, echo=FALSE}
t_test(Mean_WPM ~ Sex, data = mean_wpm, var.equal = FALSE)
```

## Differences Between Age Groups

We also still need to answer our third and last research question:

**RQ3**: Is there a difference in typing speed between our two older and younger student
groups?

<div class="question">
8. Answer RQ3. Formulate the null/alternative hypotheses, explain
whether they involve between-group or within-group designs, use the appropriate chart to
visualize the differences between the old and young participants, perform the appropriate
t-tests, and report the results.
</div>

<mark>Todo: ANOVA for >2 groups</mark>

---

*Work through the exercises, compare your results with the examples provided, and discuss any discrepancies with your peers and instructors.*

Happy analyzing!
